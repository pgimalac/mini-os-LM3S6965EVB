<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="" lang=""><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Processus et changement de contexte</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="Processus%20et%20changement%20de%20contexte_fichiers/github.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <meta name="author" content="Guillaume Duc guillaume.duc@telecom-paris.fr">

  <!--
  <link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
    code {font-family: 'Inconsolata', monospace;}
    pre {font-size: 120%;}
  </style>
  -->
</head>
<body>
<table style="border-width:0">
  <tbody><tr>
    <td>
      <img src="Processus%20et%20changement%20de%20contexte_fichiers/logo_tp_ipp.png" height="100">
    </td>
    <td>
      <h1>Projet PAF : Développement d'un petit système d'exploitation</h1>
    </td>
  </tr>
</tbody></table>

<hr>
<header id="title-block-header">
<h1 class="title">Processus et changement de contexte</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#processus">Processus</a></li>
<li><a href="#changements-de-contexte">Changements de contexte</a></li>
<li><a href="#contexte-dun-processus">Contexte d’un processus</a>
<ul>
<li><a href="#appel-dune-fonction">Appel d’une fonction</a></li>
</ul></li>
<li><a href="#exceptions-et-interruptions">Exceptions et interruptions</a>
<ul>
<li><a href="#systick">SysTick</a></li>
<li><a href="#pendsv">PendSV</a></li>
<li><a href="#déroulement-dune-exception">Déroulement d’une exception</a></li>
</ul></li>
<li><a href="#modes-dexécution-piles-et-privilèges">Modes d’exécution, piles et privilèges</a></li>
<li><a href="#pratique">Pratique</a>
<ul>
<li><a href="#objectifs">Objectifs</a></li>
<li><a href="#étapes-recommandées">Étapes recommandées</a></li>
</ul></li>
</ul>
</nav>
<p>Nous allons maintenant rentrer dans le vif du sujet et s’intéresser 
aux processus et plus particulièrement : aux structures de données 
nécessaire pour les représenter, à leur création et démarrage, et au 
basculement de l’exécution d’un processus à un autre (<em>changement de contexte</em>).</p>
<p>Dans cette page, nous allons parcourir les différents concepts mis en œuvre. <em>Ne commencez pas à coder tout de suite, lisez la page en entier et essayer de comprendre les différentes parties.</em></p>
<h1 id="processus">Processus</h1>
<p>Lors de la création d’un processus, on indiquera quelle fonction on 
souhaite faire exécuter par celui-ci. Cette fonction s’exécutera dans le
 contexte de ce processus et quand elle sera terminée, le processus sera
 considéré comme terminé.</p>
<p>Ce mode de fonctionnement (regrouper le système d’exploitation ainsi 
que le code des différents processus dans une seule image) permettra 
d’éviter de devoir se préoccuper pour le moment du chargement de 
plusieurs exécutables en mémoire, du partitionnement de celle-ci, etc., 
le tout étant fait par l’éditeur des liens ici.</p>
<p>Pour la création d’un processus, on cherchera donc à coder une fonction ayant la signature suivante :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">typedef</span> <span class="dt">void</span> *(*task_func_c)(<span class="dt">void</span> *);</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="dt">int</span> new_task(task_func_t f, <span class="dt">void</span> *arg);</span></code></pre></div>
<p>La fonction exécutée dans le nouveau processus aura donc la signature suivante :</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="dt">void</span> * foo(<span class="dt">void</span> *arg);</span></code></pre></div>
<p>L’argument (de type <code>void *</code>) permettra de passer à cette fonction des données en entrée, et la valeur de retour (également de type <code>void *</code>) lui permettra de transmettre des données en retour au système à la fin du processus.</p>
<h1 id="changements-de-contexte">Changements de contexte</h1>
<p>Une fois les processus créés, il va falloir les programmer pour l’exécution.</p>
<p>Les différents processus vont se partager le temps processeur les uns à la suite des autres (<em>time sharing</em>). Un timer permettra régulièrement au système d’exploitation de reprendre la main (<em>multitâche préemptif</em>) pour allouer le temps processeur à un autre processus.</p>
<p>Lors d’un changement de contexte, il faudra sauvegarder l’état du processus actuel puis restaurer l’état du processus suivant.</p>
<h1 id="contexte-dun-processus">Contexte d’un processus</h1>
<p>Il va donc falloir trouver ce qui fait partie du contexte d’exécution
 d’un processus, c’est-à-dire ce qui doit être sauvegardé (ainsi que par
 qui et où) et restauré lors du passage de l’exécution d’un processus à 
un autre.</p>
<h2 id="appel-dune-fonction">Appel d’une fonction</h2>
<p>Cela peut paraître anecdotique et sans lien avec le sujet mais on 
commencera par s’intéresser à ce qui se passe lors d’un appel de 
fonction. Cherchez les réponses aux questions suivantes, notamment dans 
le document <em>Procedure Call Standard for the Arm Architecture</em> (le lien est dans la première page du projet) :</p>
<ol type="1">
<li>Que fait la fonction appelante lors d’un appel à une sous-fonction ?</li>
<li>Que fait la fonction appelée au début et à la fin de son exécution ?</li>
<li>Que fait la fonction appelante à la fin de l’exécution de la sous-fonction ?</li>
</ol>
<h1 id="exceptions-et-interruptions">Exceptions et interruptions</h1>
<p>Nous aurons besoin du mécanisme d’exception pour gérer les quantums de temps processeur et les changements de contexte.</p>
<h2 id="systick">SysTick</h2>
<p>Le timer que nous allons utiliser est le <em>SysTick</em> qui permet le déclenchement périodique d’une exception.</p>
<p>Regardez comment il fonctionne et comment le programmer.</p>
<h2 id="pendsv">PendSV</h2>
<p>Nous utiliserons également une deuxième exception, qui sera chargée uniquement de faire les changements de contexte : <em>PendSV</em>. L’exception <em>SysTick</em> programmera le déclenchement de cette dernière si un changement de contexte est nécessaire.</p>
<p>Regardez comment déclencher cette exception.</p>
<h2 id="déroulement-dune-exception">Déroulement d’une exception</h2>
<p>Regardez ce qui se passe lorsqu’une exception se déclenche et se qui se passe à la fin du traitement d’une interruption.</p>
<p>Vous devriez maintenant avoir un aperçu de ce que constitue le 
contexte d’exécution d’un processus, comment et où se passe sa 
sauvegarde lors du déclenchement d’une exception.</p>
<h1 id="modes-dexécution-piles-et-privilèges">Modes d’exécution, piles et privilèges</h1>
<p>Regardez les modes d’exécution <em>Handler</em> et <em>Thread</em>, ainsi que les deux pointeurs de pile proposés (<em>Main stack</em> et <em>Process stack</em>). Comment passer de l’une à l’autre ? Comment pourrions-nous les utiliser ?</p>
<p>Regardez les deux niveaux de privilèges et comment passer de l’un à l’autre.</p>
<h1 id="pratique">Pratique</h1>
<h2 id="objectifs">Objectifs</h2>
<p>Une fois que vous avez vu les différentes parties ci-dessus et 
cherché les informations demandées, vous devriez avoir tout en main pour
 écrire :</p>
<ul>
<li>La fonction créant une tâche</li>
<li>Le déclenchement régulier d’une exception</li>
<li>Le choix du prochain processus à exécuter</li>
<li>Le changement de contexte vers ce nouveau processus</li>
<li>Toutes les structures de données et fonctions auxiliaires nécessaires</li>
</ul>
<p>Il s’agit probablement de l’étape la plus compliquée de tout le 
projet. Prenez votre temps, n’hésitez pas à interagit avec votre 
encadrant, notamment à chaque étape pour vérifier que vous partez dans 
la bonne direction.</p>
<p>N’hésitez pas non plus à le solliciter pour qu’il vous explique, s’il ne l’a pas déjà fait, comment utiliser <code>gdb</code> pour déboguer votre code avec <code>QEMU</code>.</p>
<p>Testez avec au minimum deux processus. Vérifiez qu’ils fonctionnent bien.</p>
<h2 id="étapes-recommandées">Étapes recommandées</h2>
<p>Voici quelques étapes que je vous conseille de suivre :</p>
<ol type="1">
<li><p>Configurez le mécanisme <em>SysTick</em> pour qu’il génère une 
exception toutes les secondes (approximativement). Affichez un caractère
 à chaque déclenchement pour vérifier que tout fonctionne.</p></li>
<li><p>Faites en sorte que le gestionnaire d’exception <em>SysTick</em> déclenche l’exception <em>PendSV</em>. De même, testez en faisant afficher un caractère au gestionnaire de <em>PendSV</em>.</p></li>
<li><p>Créez les structures de données qui vont être nécessaires pour gérer un processus et les changements de contexte :</p></li>
</ol>
<ul>
<li>Table des processus</li>
<li>Pile d’un processus</li>
<li>Structure représentant la partie du contexte sauvegardée par le processeur</li>
<li>Structure représentant la partie du contexte sauvegardée logiciellement</li>
<li>Pointeurs vers le processus courant et le prochain</li>
</ul>
<ol type="1" start="4">
<li><p>Créez deux fonctions (qui seront exécutées dans deux processus 
différents) qui ne font qu’en boucle afficher un caractère et faire une 
attente active</p></li>
<li><p>Codez l’ordonnanceur et appelez le depuis le gestionnaire d’exception <em>SysTick</em></p></li>
<li><p>Codez (<em>en assembleur</em>) le gestionnaire d’exception <em>PendSV</em>
 (qui fait le véritable changement de contexte), la partie sauvegarde du
 contexte du processus courant (si celui-ci n’est pas inexistant) :</p></li>
</ol>
<ul>
<li>Sauvegardez dans la pile (<em>process stack</em>) du processus courant les registres qui ne l’ont pas été automatiquement</li>
<li>Sauvegardez le pointeur de pile mis à jour (après l’étape précédente) dans l’entrée correspondante de la table des processus</li>
</ul>
<ol type="1" start="7">
<li>Codez ensuite, toujours en assembleur et dans <em>PendSV</em> la partie restauration du contexte du prochain processus :</li>
</ol>
<ul>
<li>Restaurez depuis la pile du prochain processus, les registres qui doivent être restaurés logiciellement</li>
<li>Positionnez le pointeur de pile mis à jour (<em>PSP</em>)</li>
<li>Chargez dans le registre <em>pc</em> la valeur magique qui permet de revenir en mode <em>thread</em> avec utilisation de la <em>PSP</em></li>
</ul>
<ol type="1" start="8">
<li>Créez la fonction qui crée un nouveau processus</li>
</ol>
<ul>
<li>Créez l’entrée dans la table des processus</li>
<li>Initialisez la pile en la remplissant avec un contexte (matériel et logiciel) initial correct (notamment <em>r0</em>, <em>pc</em>, <em>xpsr</em>)</li>
<li>Initialisez le pointeur de pile initial du processus dans la table des processus</li>
</ul>
<ol type="1" start="9">
<li><p>Dans <em>main</em>, créez deux processus</p></li>
<li><p>Configurez les interruptions pour que l’exception <em>PendSV</em> ait la priorité minimale et <em>SysTick</em>, la priorité maximale</p></li>
<li><p>Une fois tous les processus créés et les interruptions configurées, relâchez les privilèges</p></li>
<li><p>Testez et débuggez le tout…</p></li>
</ol>
<p>Discutez avec votre encadrant avant d’aller plus loin, c’est-à-dire à la <a href="https://perso.telecom-paristech.fr/duc/cours/paf/mini-os/mini-os-4.html">page suivante</a>.</p>
<hr>
<p>© Copyright 2020 Guillaume Duc. Le contenu de cette page est
  mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Licence
  Creative Commons Attribution - Partage dans les Mêmes Conditions 4.0
  International</a> (à l'exception des exemples de code tirés du noyau
  Linux et qui sont distribués sous leurs licences d'origine).</p>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Licence
Creative Commons" style="border-width:0" src="Processus%20et%20changement%20de%20contexte_fichiers/cc_by_sa.png"></a>


</body></html>